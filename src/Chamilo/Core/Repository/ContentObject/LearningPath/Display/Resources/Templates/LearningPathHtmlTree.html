<!--suppress ALL -->
<style>
    .ws-wrap {
        white-space: normal;
        height: auto;
        width: 83%;
    }

    span.fancytree-node span.fancytree-expander {
        color: #428bca;
    }

    span.fancytree-node span.fancytree-expander:hover {
        color: #428bca;
        opacity: 0.6;
    }

    .fancytree-custom-icon {
        height: 16px !important;
        width: 16px !important;
    }

    .fancytree-container {
        border: none !important;
        min-height: 100px;
        overflow: auto;
    }

    span.fancytree-title {
        color: #337ab7;
        font-size: 14px;
    }

    div.fancytree-edit-mode span.fancytree-title {
        color: #b79b00;
        font-size: 14px;
    }

    /*span.fancytree-title:hover {
        text-decoration: underline;
    }*/

    .fa {
        width: inherit;
        text-align: inherit;
    }
    .btn-drag {
        width: 100%;
    }

    .alert-drag {
        padding: 1px 1px 1px 5px;
        margin-bottom: 0px;
        margin-top: 5px;
    }

    .tree-disabled{
        background: #e9e9e9;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        opacity: 0.5;
    }
    .tree-loading{
        float: left;
        height: 100%;
        z-index: 20;
        position: absolute;
        top: 30%;
        left: 45%;
    }
</style>

<div class="learning-path-html-tree" ng-app="learningPathHtmlTreeApp" ng-cloak
     ng-controller="learningPathHtmlTreeController">
    <button class="btn btn-default btn-xs btn-drag" ng-click="enableDrag()" ng-show="!dragEnabled && canEditLearningPathTree && !inReportingMode">Activeer Verslepen</button>
    <button class="btn btn-warning btn-xs btn-drag" ng-click="disableDrag()" ng-show="dragEnabled && canEditLearningPathTree && !inReportingMode">Stop met verslepen</button>
    <div ng-show="showError" class="alert alert-danger alert-drag">
        <strong>Status:</strong> Er ging iets mis, gelieve de pagina te herladen.
    </div>
    <div class="tree-loading text-center" ng-show="isLoading">
        <img border="0" src="http://localhost:8081/cosnics/web/Chamilo/Configuration/Resources/Images/Aqua/Action/LoadingHuge.gif">
    </div>
    <div id="tree" ng-class="{'tree-disabled': isLoading}">
    </div>
</div>

<script>
    (function () {

            var repoDragPanelApp = angular.module('learningPathHtmlTreeApp', ['ui.bootstrap', 'ngSanitize']);

            repoDragPanelApp.controller(
                'learningPathHtmlTreeController',
                ['$scope', '$http', function ($scope, $http) {

                    $scope.canEditLearningPathTree = {{ canEditLearningPathTree }};
                    $scope.inReportingMode = {{ inReportingMode }};
                    $scope.isLoading = false;
                    $scope.showError = false;

                    var extractContextMenuItemFromNodeAction = function(node, action) {
                        if(node.data.actions[action] === undefined) return null;

                        var nodeActionData = node.data.actions[action];
                        return {
                            name: nodeActionData.title,
                            icon: nodeActionData.image,
                            callback: function () {
                                if(nodeActionData.confirm)
                                {
                                    var result = confirm(nodeActionData.confirmation_message);
                                    if(result === false)
                                    {
                                        return;
                                    }
                                }

                                window.location.href = nodeActionData.url;
                            }
                        }
                    };

		            var treeData = {{ treeData }};

                    if(!$scope.inReportingMode) {
                        $.contextMenu({
                            selector: ".fancytree-title",
                            zIndex: 10001,
                            build: function ($triggerElement, e) {
                                node = $.ui.fancytree.getNode($triggerElement);
                                if (node) {
                                    node.setFocus(true);
                                }
                                return {
                                    items: function () { //todo retrieve from node
                                        var items = {};

                                        if ($scope.canEditLearningPathTree) {
                                            if (node.folder === true) {
                                                items["addSection"] =
                                                    {
                                                        name: "Voeg sectie toe",
                                                        icon: "fa-plus",
                                                        callback: function () {
                                                            node.editCreateNode("child", {
                                                                title: "Pas titel aan...",
                                                                folder: true
                                                            });
                                                        }
                                                    };

                                                items["addItem"] = {
                                                    name: "Voeg pagina toe",
                                                    icon: "fa-plus",
                                                    callback: function () {
                                                        node.editCreateNode("child", {
                                                            title: "Pas titel aan...",
                                                            folder: false
                                                        });
                                                    }
                                                };

                                                items['sep0'] = '-';

                                            }

                                            items["editTitle"] = {
                                                name: "Pas titel aan", icon: "fa-edit", callback: function () {
                                                    node.editStart()
                                                }
                                            };

                                            var actions = ['edit', 'delete', 'move', '-', 'block', '-', 'reporting',
                                                'progress', '-', 'activity', 'manage'];
                                        }
                                        else {
                                            var actions = ['progress', 'activity'];
                                        }

                                        var separatorCounter = 1;

                                        actions.forEach(function (action) {
                                            if (action === '-') {
                                                items['sep' + separatorCounter] = '-';
                                                separatorCounter++;
                                            }
                                            else {
                                                var item = extractContextMenuItemFromNodeAction(node, action);
                                                if (item !== null) {
                                                    items[action] = item;
                                                }
                                            }
                                        });

                                        return items;
                                    }()
                                };
                            }
                        });
                    }

                    var fetchTreeNodesAjaxUrl = "{{ fetchTreeNodesAjaxUrl }}";

                    $scope.dragEnabled = false;

                    var reloadTreeWithFreshData = function() {
                        $http.get(
                            fetchTreeNodesAjaxUrl,
                            {headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'}}
                        ).then(function successCallback(response) {
                                treeData = response.data;
                                $("#tree").fancytree('getTree').reload(treeData);
                            }, function errorCallback(response) {
                                //@todo alert
                            }
                        );
                    }

                    var tree = $("#tree").fancytree({
                        source: treeData,
                        glyph: {
                            map: {
                                checkbox: "glyphicon glyphicon-unchecked",
                                checkboxSelected: "glyphicon glyphicon-check",
                                checkboxUnknown: "glyphicon glyphicon-share",
                                dragHelper: "glyphicon glyphicon-play",
                                dropMarker: "glyphicon glyphicon-arrow-right",
                                error: "glyphicon glyphicon-warning-sign",
                                expanderClosed: "glyphicon glyphicon-chevron-right",
                                expanderLazy: "glyphicon glyphicon-plus-sign",
                                expanderOpen: "glyphicon glyphicon-chevron-down",
                                loading: "glyphicon glyphicon-refresh glyphicon-spin",
                                nodata: "glyphicon glyphicon-info-sign",
                                // Default node icons.
                                // (Use tree.options.icon callback to define custom icons based on node data)
                                doc: "glyphicon glyphicon-file",
                                docOpen: "glyphicon glyphicon-file",
                                folder: "glyphicon glyphicon-folder-close",
                                folderOpen: "glyphicon glyphicon-folder-open"
                            }
                        },
                        dnd: {
                            // Available options with their default:
                            autoExpandMS: 250,   // Expand nodes after n milliseconds of hovering
                            draggable: null,      // Additional options passed to jQuery UI draggable
                            droppable: null,      // Additional options passed to jQuery UI droppable
                            dropMarkerOffsetX: -24,  // absolute position offset for .fancytree-drop-marker
                            // relatively to ..fancytree-title (icon/img near a node accepting drop)
                            dropMarkerInsertOffsetX: -16, // additional offset for drop-marker with hitMode = "before"/"after"
                            focusOnClick: false,  // Focus, although draggable cancels mousedown event (#270)
                            preventRecursiveMoves: true, // Prevent dropping nodes on own descendants
                            preventVoidMoves: true,      // Prevent dropping nodes 'before self', etc.
                            smartRevert: true,    // set draggable.revert = true if drop was rejected

                            // Events that make tree nodes draggable
                            dragStart: function (node, data) {
                                if(!$scope.dragEnabled) {
                                    return false;
                                }
                                if(node.getParent().isRoot()) { //fancytree has an invisible root
                                    return false; // do not drag the learning path root
                                }
                                return true;
                            },
                            initHelper: null,     // Callback(sourceNode, data)
                            updateHelper: null,   // Callback(sourceNode, data)

                            // Events that make tree nodes accept draggables
                            dragEnter: function (node, data) {
                                if(node.getParent().isRoot()) {
                                    return [];
                                }
                                if (!node.isFolder()) {
                                    return ["before", "after"];
                                }
                                return true;
                            },      // Callback(targetNode, data)
                            dragExpand: function(node, data) {
                                // return false to prevent auto-expanding data.node on hover
                            },
                            dragOver: function(node, data) {
                            },
                            dragLeave: function(node, data) {
                            },
                            dragStop: function(node, data) {
                            },
                            dragDrop: function(node, data) {
                                $scope.isLoading = true;
                                data.otherNode.moveTo(node, data.hitMode);

                                var displayOrder = data.otherNode.getIndex() + 1;
                                var parentId = data.otherNode.getParent().key;
                                var childId = data.otherNode.key;

                                //persist
                                $http.post(
                                    '{{ moveTreeNodeAjaxUrl }}',
                                    $.param({'child_id': childId, 'parent_id': parentId, 'display_order': displayOrder}),
                                    {headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'}}
                                ).then(function successCallback(response) {
                                        $scope.isLoading = false;
                                    }, function errorCallback(response) {
                                        $scope.isLoading = false;
                                        $scope.showError = true;
                                        reloadTreeWithFreshData(); //reset tree
                                    }
                                );
                            }
                        },
                        minExpandLevel: 2,
                        selectMode: 1,
                        checkbox: false,
                        extensions: ["dnd", "edit", "glyph", "persist"],
                        toggleEffect: false,
                        persist: {
                            store: "local" // 'cookie', 'local': use localStore, 'session': sessionStore
                        },
                        enhanceTitle: function (event, data) {
                            data.$title.addClass("ws-wrap");
                        },
                        click: function (event, data) {
                            if((data.targetType === 'title' && !$(event.originalEvent.target).hasClass('fancytree-title')) || data.targetType === undefined) {
                                return false; //if the click is on the left or on the icon, leave the node alone...
                            }

                            var node = data.node;

                            if (!$scope.dragEnabled && event.button !== 2 && $(event.originalEvent.target).hasClass('fancytree-title')) {
                                if (node.data.href) {
                                    window.location.href = node.data.href;
                                }
                            }
                            if (event.button === 2) {
                                return false;
                            }
                        },
                        renderTitle: function (event, data) {
                            if(data.node.data.number && !$scope.dragEnabled) {
                                return '<span class="fancytree-title">' + data.node.data.number + ' ' + data.node.title + '</span>';
                            } else {
                                return '<span class="fancytree-title">' + data.node.title + '</span>';
                            }

                        }

                    });

                    $scope.enableDrag = function() {
                        $scope.dragStatusClass = 'alert-info';
                        $scope.dragStatusMessage = "Alles ok"; //@todo translations
                        $scope.dragEnabled = true;
                        $("#tree").fancytree('getTree').reload(treeData);
                    }

                    $scope.disableDrag = function () {
                        $scope.dragEnabled = false;
                        reloadTreeWithFreshData();
                    }
                }]
            );
        })();
</script>


