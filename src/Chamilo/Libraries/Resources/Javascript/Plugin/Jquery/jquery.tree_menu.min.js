(function(a){a.fn.extend({tree_menu:function(n){var d={search:"",item_url:"#",collapsed:true};var c=a.extend(d,n),m=a(this);function i(o){a("ul:first",a(this).parent()).hide();if(a(this).hasClass("lastCollapse")){a(this).removeClass("lastCollapse");a(this).addClass("lastExpand")}else{if(a(this).hasClass("collapse")){a(this).removeClass("collapse");a(this).addClass("expand")}}}function e(o){a("ul:first",a(this).parent()).show();j(a(this))}function j(o){if(o.hasClass("lastExpand")){o.removeClass("lastExpand");o.addClass("lastCollapse")}else{if(o.hasClass("expand")){o.removeClass("expand");o.addClass("collapse")}}}function k(q){var r=a("a",a(this)).attr("id");var p=a(this).parent();var o=g(r);if(o){p.append(o);j(a(this));a(this).unbind("click");b(a(this).parent().parent().parent())}}function g(r){if(c.search==""){return""}var q=a("<ul></ul>");var p=h(r);var o=a.xml2json(p,true);if((o.leaf&&a(o.leaf).size()>0)){a.each(o.leaf,function(t,v){var u="";if(v.has_children=="1"){u=' class="expand"'}item_url=sprintf(c.item_url,v.id);var s=a("<li><div"+u+'><a href="'+item_url+'" id="'+v.id+'" class="'+v.classes+'" title="'+v.title+'">'+v.title+"</a></div></li>");a(q).append(s)});return q}}function h(p){var o=a.ajax({type:"GET",dataType:"xml",url:c.search,data:{parent_id:p},async:false}).responseText;return o}function b(o){a("ul li:last-child > div",o).addClass("last");a("ul li:last-child > div.expand",o).addClass("lastExpand");a("ul li:last-child > div.expand",o).removeClass("expand");a("ul li:last-child > ul",o).css("background-image","none");a("ul li:not(:last-child):has(ul) > div",o).addClass("collapse");a("ul li:last-child:has(ul) > div",o).addClass("lastCollapse");a("ul li > div > a",o).click(function(p){p.stopPropagation()})}function f(){if(c.search==""){var o=m.attr("id");a("#"+o+" ul li:has(ul) > div.collapse").trigger("click");a("#"+o+" ul li:has(ul) > div.lastCollapse").trigger("click");a("#"+o+" ul li.current > div.expand").trigger("click");a("#"+o+" ul li.current > div.lastExpand").trigger("click");a("#"+o+" ul li.current").parents("li.current_path").each(function(p){a("div:first",a(this)).trigger("click")})}}function l(){b(m);var o=m.attr("id");a(document).on("click","#"+o+" ul li:not(:has(ul)) > div.expand",k);a(document).on("click","#"+o+" ul li:not(:has(ul)) > div.lastExpand",k);a(document).on("click","#"+o+" ul li:has(ul) > div.expand",e);a(document).on("click","#"+o+" ul li:has(ul) > div.lastExpand",e);a(document).on("click","#"+o+" ul li:has(ul) > div.collapse",i);a(document).on("click","#"+o+" ul li:has(ul) > div.lastCollapse",i);if(c.collapsed){f()}}return this.each(l)}})})(jQuery);