(function($){$.fn.extend({advelementfinder:function(options){var defaults={name:"",elementTypes:null,defaultValues:null,maxItems:100,maxSelectableItems:null};var settings=$.extend(defaults,options);var ajaxUri=getPath("WEB_PATH")+"index.php";var self=this;var inactiveBox;var activeBox;var lastSelectedElements=[];var activatedElements=[];var selectedFilter;var tempFilterBox;var offset=0;function removeActivatedElementFromArray(id){var index=$.inArray(id,activatedElements);if(index!=-1){activatedElements.splice(index,1)}}function addActivatedElementsToForm(){var encoded="[";var size=activatedElements.length;for(var i=0;i<size;i++){var element=activatedElements[i];encoded+='"'+element+'"';if(i<size-1){encoded+=","}}encoded+="]";$("#hidden_active_elements",self).val(encoded)}function enableElement(theElement){if(typeof theElement.css("background-image")!=="undefined"){theElement.removeClass("disabled");theElement.css("background-image",theElement.css("background-image").replace("Na.png",".png"));var filterBoxes=$(".filter_box",self);$("#"+theElement.attr("id"),filterBoxes).attr("disabled","")}}function disableElement(theElement){if(theElement.css("background-image")){if(!theElement.hasClass("disabled")){theElement.addClass("disabled");theElement.css("background-image",theElement.css("background-image").replace(".png","Na.png"));var filterBoxes=$(".filter_box",self);$("#"+theElement.attr("id"),filterBoxes).attr("disabled","disabled")}}}function activateElements(e){e.preventDefault();var selectedElements=$(".selected",inactiveBox);$.each(selectedElements,function(){if(settings.maxSelectableItems!=null&&(selectedElements.length+activatedElements.length>settings.maxSelectableItems)){alert(getTranslation("TooManyItemsSelected",{MAX_ITEMS:settings.maxSelectableItems},"Chamilo\\Libraries"));return false}$(this).removeClass("selected");$(this).removeClass("lastSelected");var selectedElementLi=$(this).closest("li");var elementHtml=selectedElementLi.html();var newElementLi=$("<li />",{html:elementHtml});addElementTo(newElementLi,activeBox);activatedElements.push($(this).attr("id"));disableElement($(this))});activationPostProcess(inactiveBox);return false}function deactivateElements(e){e.preventDefault();var selectedElements=$(".selected",activeBox);$.each(selectedElements,function(){var selectedId=$(this).attr("id");var selectedElementLi=$(this).closest("li");selectedElementLi.remove();removeActivatedElementFromArray(selectedId);var disabledElement=$("a#"+selectedId,inactiveBox);enableElement(disabledElement)});activationPostProcess(activeBox);return false}function activationPostProcess(box){var lastSelectedElement=$(".lastSelected",box);if(lastSelectedElement.length==0){lastSelectedElements[box.attr("id")]=null}setActivateElementsButtonState();processTree();addActivatedElementsToForm()}function setActivateElementsButtonState(){if(settings.maxSelectableItems!=null&&activatedElements.length>=settings.maxSelectableItems){$("input.activate_elements",self).addClass("disabled");$("input.activate_elements",self).attr("disabled","disabled")}else{$("input.activate_elements",self).removeClass("disabled");$("input.activate_elements",self).removeAttr("disabled")}}function selectElement(e){e.preventDefault();var selectedUl=$(this).closest("ul");var selectedBoxId=selectedUl.closest("div").attr("id");var lastSelectedElement=lastSelectedElements[selectedBoxId];if(lastSelectedElement){var lastSelectedUl=lastSelectedElement.closest("ul")}if(e.shiftKey&&lastSelectedUl&&selectedUl.get(0)==lastSelectedUl.get(0)){$(".selected",$(this).parents("ul")).removeClass("selected");var elementsLi=selectedUl.children("li");var selectedElementLi=$(this).closest("li");var lastSelectedElementLi=lastSelectedElement.closest("li");var currentLiIndex=elementsLi.index(selectedElementLi);var lastSelectedLiIndex=elementsLi.index(lastSelectedElementLi);var start=Math.min(lastSelectedLiIndex,currentLiIndex);var end=Math.max(lastSelectedLiIndex,currentLiIndex);for(var i=start;i<=end;i++){var elementLi=elementsLi.eq(i);var element=$("a",elementLi);if(!element.hasClass("disabled")){element.addClass("selected")}}}else{if(e.ctrlKey||e.metaKey){$(this).toggleClass("selected")}else{$(".selected",$(this).parents("ul")).removeClass("selected");$(this).addClass("selected")}$(".lastSelected",$(this).parents("ul")).removeClass("lastSelected");$(this).addClass("lastSelected");lastSelectedElements[selectedBoxId]=$(this)}return false}function elementDoubleClicked(e){var filterBoxSelect=$(".filter_box:last > select",self);if(filterBoxSelect.length==0){return false}var id=$(this).attr("id");var option=$("#"+id,filterBoxSelect);if(option.length>0){filterBoxSelect.val(id);filterBoxSelect.change()}return false}function processTree(){$("div",self).removeClass("last");$("ul li:last-child > div",self).addClass("last");$("ul li:last-child > ul",self).css("background-image","none")}function showElementFinder(e){e.preventDefault();$(this).hide();$("#"+settings.name+"_collapse_button").show();self.show()}function hideElementFinder(e){e.preventDefault();$(this).hide();$("#"+settings.name+"_expand_button").show();self.hide()}function elementTypeSelected(e){$(".filter_box",self).remove();delete (selectedFilter);$("#search_field",self).val("");offset=0;updateElements()}function filterBoxSelected(e){var parentFilterBox=$(this).closest(".filter_box");parentFilterBox.nextAll().remove();$("#search_field",self).val("");var value=$(this).val();if(value==-1){var previousBox=parentFilterBox.prev();if(previousBox){value=$("select",previousBox).val()}else{value=0}parentFilterBox.remove()}selectedFilter=value;offset=0;updateElements()}function searchFieldChanged(e){if(e.keyCode==13){var query=$(this).val();if(query.length==0){offset=0;updateElements(true)}else{var replacedQuery=str_replace("*","",query);if(replacedQuery.length==0){inactiveBox.html(getTranslation("QueryCanNotBeStarsOnly",null,"Chamilo\\Libraries"))}else{if(replacedQuery.length<3){inactiveBox.html(getTranslation("QueryMinimum3Characters",null,"Chamilo\\Libraries"))}else{offset=0;updateElements(true)}}}return false}return true}function selectOtherElements(multiplier){offset=offset+(multiplier*settings.maxItems);updateElements()}function updateElements(is_search){inactiveBox.html('<div class="element_finder_loading"><span class="fas fa-spinner fa-pulse fa-4x"></span></div>');var selectedTypeId=$("#element_types_selector",self).val();if(selectedTypeId==-1){inactiveBox.html(getTranslation("SelectElementType",null,"Chamilo\\Libraries"));return}var elementType=getElementTypeById(selectedTypeId);var query=$("#search_field",self).val();var result=loadElements(elementType,query,selectedFilter);if(result.properties.elements&&result.properties.elements.length>0){var totalElements=result.properties.total_elements;var hasNextElements=(offset+settings.maxItems<=totalElements);var hasPreviousElements=(offset>0);inactiveBox.html("");lastSelectedElements.inactive_box=null;if(hasPreviousElements){var previousDiv=$('<div class="previous_elements"><span class="fas fa-chevron-circle-up fa-fw fa-lg"></span></div>');inactiveBox.append(previousDiv)}var elementsDiv=$("<div />");inactiveBox.append(elementsDiv);tempFilterBox=createFilterBox();buildInactiveElements(result.properties.elements,elementsDiv);if(!is_search&&$("select",tempFilterBox).children().length>0){var option=createFilterOption(-1,getTranslation("SelectFilter",null,"Chamilo\\Libraries"));$("select",tempFilterBox).prepend(option);$("select",tempFilterBox).prop("selectedIndex",0);$(".element_finder_types",self).append(tempFilterBox);tempFilterBox=null}tempFilterBox=null;if(hasNextElements){var nextDiv=$('<div class="next_elements"><span class="fas fa-chevron-circle-down fa-fw fa-lg"></span></div>');inactiveBox.append(nextDiv)}processTree()}else{inactiveBox.html(getTranslation("NoSearchResults",null,"Chamilo\\Libraries"))}}function getElementTypeById(id){for(var i=0;i<settings.elementTypes.length;i++){if(settings.elementTypes[i].id==id){return settings.elementTypes[i]}}return null}function loadElements(elementType,query,filter){var parameters={application:elementType.application,go:elementType.go,query:query,filter:filter,offset:offset};if(elementType.parameters){$.extend(parameters,elementType.parameters)}var result=doAjaxPost(ajaxUri,parameters);result=eval("("+result+")");return result}function buildInactiveElements(elements,parent){$.each(elements,function(i,element){var selected=($.inArray(element.id,activatedElements)!=-1);if(element.type>1){var option=createFilterOption(element.id,element.title);if(selected){option.attr("disabled","disabled")}$("select",tempFilterBox).append(option)}var elementLi=buildElement(element,parent);var elementLink=$("a",elementLi);if(selected){disableElement(elementLink)}if(element.type==3){elementLink.addClass("filter")}buildInactiveElements(element.children,elementLi)})}function buildActiveElements(elements,parent){$.each(elements,function(i,element){var elementLi=buildElement(element,parent);activatedElements.push(element.id);buildActiveElements(element.children,elementLi)})}function buildElement(element,parent){var elementLi=createElement(element.id,element.classes,element.title,element.description);addElementTo(elementLi,parent);return elementLi}function createElement(id,classes,title,description){var li=$("<li />");var div=$("<div />");var item=$("<a />",{id:id,href:"#",title:description,text:" "+title});var glyph=$("<span />",{"class":classes});item.prepend(glyph);div.append(item);li.append(div);return li}function addElementTo(li,parent_element){var ul=parent_element.children("ul");if(!ul.is("ul")){ul=$("<ul />");if(parent_element.is("div")){ul.addClass("tree-menu")}}ul.append(li);parent_element.append(ul)}function createFilterBox(){var div=$("<div>",{"class":"filter_box form-group"});var filterbox=$('<select class="form-control">');$(div).append(filterbox);return div}function createFilterOption(id,title){var option=$("<option>",{id:id,value:id,text:title});return option}function initElements(){activeBox.html("");activatedElements=[];lastSelectedElements=[];delete (selectedFilter);if(settings.elementTypes.length==1){$("#element_types_selector",self).prop("selectedIndex",1);$("#element_types_selector",self).parent().toggle()}else{$("#element_types_selector",self).prop("selectedIndex",0)}$(".filter_box",self).remove();if(settings.defaultValues){buildActiveElements(settings.defaultValues,activeBox);addActivatedElementsToForm();processTree();setActivateElementsButtonState()}updateElements()}function init(){inactiveBox=$("#inactive_elements",self);activeBox=$("#active_elements",self);initElements();$(self).on("change","#element_types_selector",elementTypeSelected);$(self).on("change",".filter_box > select",filterBoxSelected);$(self).on("click","a:not(.disabled, .category, .filter)",selectElement);$(inactiveBox).on("dblclick","a:not(.disabled, .category)",elementDoubleClicked);$(self).on("click","a.disabled, a.category, a.filter",function(){return false});$(".element_query").keypress(searchFieldChanged);$(self).on("click",".previous_elements",function(){selectOtherElements(-1)});$(self).on("click",".next_elements",function(){selectOtherElements(1)});$(self).on("click","#activate_button",activateElements);$(self).on("click","#deactivate_button",deactivateElements);$("#"+settings.name+"_expand_button").click(showElementFinder);$("#"+settings.name+"_collapse_button").click(hideElementFinder);$(document).on("click",":reset",initElements)}return this.each(init)}})})(jQuery);